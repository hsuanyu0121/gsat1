<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P!LOT | 8ç§‘å…¨èƒ½å°èˆª</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --navy: #1e3a8a; }
        body { background-color: #f8fafc; height: 100vh; overflow: hidden; display: flex; font-family: sans-serif; }
        .column { height: 100vh; overflow-y: auto; padding: 20px; border-right: 1px solid #e2e8f0; }
        .timer-card { background: #1e293b; border: 1px solid #334155; padding: 10px; border-radius: 12px; text-align: center; transition: 0.3s; }
        .timer-card.active { border-color: #38bdf8; box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        .hidden { display: none !important; }
        .card-btn { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 15px; cursor: pointer; transition: 0.2s; }
        .card-btn:hover { border-color: var(--navy); transform: translateY(-2px); }
    </style>
</head>
<body class="flex">

    <aside class="column w-1/3 bg-white shadow-xl z-20">
        <h1 class="text-3xl font-black text-blue-900 italic mb-6 text-center">P!LOT</h1>
        
        <div id="authSection" class="mb-6">
            <div id="loginGroup">
                <button onclick="signInWithGoogle()" class="w-full py-3 border-2 border-blue-900 text-blue-900 rounded-xl font-bold hover:bg-blue-900 hover:text-white transition">Google ç™»å…¥</button>
            </div>
            <div id="userInfo" class="hidden flex flex-col gap-2 p-3 bg-blue-50 rounded-xl border border-blue-100">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" class="w-8 h-8 rounded-full border border-white" src="">
                    <p id="userName" class="text-xs font-black text-slate-700 truncate"></p>
                </div>
                <button onclick="signOut()" class="text-[10px] text-red-500 font-bold text-left hover:underline">ç™»å‡ºç³»çµ±</button>
            </div>
        </div>

        <div class="p-4 bg-slate-900 rounded-2xl shadow-lg">
            <h4 class="text-[10px] text-slate-400 font-bold mb-4 uppercase tracking-widest text-center">Focus Grid (8 Subjects)</h4>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <script>
                    const subjects = [
                        { id: 'math', name: 'æ•¸å­¸' }, { id: 'eng', name: 'è‹±æ–‡' },
                        { id: 'man', name: 'åœ‹æ–‡' }, { id: 'phy', name: 'ç‰©ç†' },
                        { id: 'che', name: 'åŒ–å­¸' }, { id: 'bio', name: 'ç”Ÿç‰©' },
                        { id: 'ear', name: 'åœ°ç§‘' }, { id: 'soc', name: 'ç¤¾æœƒ' }
                    ];
                    subjects.forEach(s => {
                        document.write(`
                            <div id="card-${s.id}" class="timer-card">
                                <p class="text-[9px] text-blue-400 font-bold">${s.name}</p>
                                <p id="timer-${s.id}" class="text-sm font-mono font-bold text-white my-1">00:00:00</p>
                                <button id="btn-${s.id}" onclick="toggleTimer('${s.id}')" class="w-full py-1 bg-blue-600 rounded-md text-[9px] font-bold">é–‹å§‹</button>
                            </div>
                        `);
                    });
                </script>
            </div>
            <button onclick="openShareModal()" class="w-full py-3 bg-slate-700 text-white rounded-xl text-[10px] font-bold hover:bg-slate-600 transition">ğŸ“¸ è£½ä½œ 8ç§‘æ•¸æ“šå¡</button>
        </div>
    </aside>

    <main class="column w-2/5 bg-slate-50 border-r border-slate-200 flex flex-col">
        <h2 class="text-2xl font-black text-slate-800 text-center mb-6 italic">ğŸ¤– AI è¦–è¦ºç›²å€è¨ºæ–·</h2>
        <div id="aiResponse" class="hidden bg-white p-6 border border-slate-200 shadow-sm mb-6 flex-1 flex flex-col">
            <div id="aiText" class="text-slate-600 leading-relaxed text-base whitespace-pre-wrap overflow-y-auto"></div>
        </div>
        <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200">
            <textarea id="aiInput" rows="2" class="w-full text-base border-none outline-none resize-none" placeholder="è¼¸å…¥é¡Œç›®æˆ–æ‹ç…§..."></textarea>
            <div id="previewContainer" class="hidden mb-2 text-center relative"><img id="imgPreview" class="max-h-24 rounded-lg mx-auto"></div>
            <div class="flex justify-between items-center mt-2 border-t pt-3">
                <button onclick="document.getElementById('fileInput').click()" class="text-navy font-bold text-sm">ğŸ“· æ‹ç…§</button>
                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleImage(this)">
                <button id="aiBtn" class="bg-blue-900 text-white px-8 py-2 rounded-xl font-bold text-sm shadow-lg">é–‹å§‹è¨ºæ–·</button>
            </div>
        </div>
    </main>

    <nav class="column w-1/4 bg-white">
        <div class="space-y-6">
            <section class="p-4 bg-slate-50 rounded-[2rem] border border-slate-100 shadow-inner">
                <h4 class="text-sm font-black text-blue-900 mb-2 italic text-center">ğŸ“Š 8ç§‘èƒ½åŠ›åœ–</h4>
                <div class="w-full aspect-square">
                    <canvas id="radarChart"></canvas>
                </div>
            </section>

            <section class="space-y-3">
                <h4 class="text-sm font-black text-slate-800 italic">ğŸ“š å°èˆªé¸å–®</h4>
                <div onclick="alert('è¼‰å…¥ 108-114 è€ƒå¤é¡Œ...')" class="card-btn flex items-center gap-3">
                    <span class="text-xl">ğŸ“</span>
                    <div><p class="text-xs font-black">è€ƒå¤é¡Œè³‡æ–™åº«</p></div>
                </div>
                <div onclick="openFolder('æˆ‘çš„éŒ¯é¡Œé›†')" class="card-btn flex items-center gap-3">
                    <span class="text-xl">ğŸ““</span>
                    <div><p class="text-xs font-black">å€‹äººéŒ¯é¡Œæœ¬</p></div>
                </div>
            </section>
        </div>
    </nav>

    <div id="shareModal" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] overflow-hidden max-w-sm w-full">
            <video id="webcam" autoplay playsinline class="w-full aspect-square object-cover"></video>
            <div class="p-4 grid grid-cols-2 gap-3">
                <button onclick="takeSnap()" class="py-3 bg-slate-900 text-white rounded-xl font-bold text-xs">ğŸ“¸ æ‹ç…§å„²å­˜</button>
                <button onclick="closeShareModal()" class="py-3 bg-slate-100 rounded-xl font-bold text-xs">å–æ¶ˆ</button>
            </div>
            <canvas id="shareCanvas" class="hidden"></canvas>
        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ– 8 ç§‘æ•¸æ“š
        let base64Image = null;
        let timers = {
            math: { s: 0, iv: null, run: false }, eng: { s: 0, iv: null, run: false },
            man: { s: 0, iv: null, run: false }, phy: { s: 0, iv: null, run: false },
            che: { s: 0, iv: null, run: false }, bio: { s: 0, iv: null, run: false },
            ear: { s: 0, iv: null, run: false }, soc: { s: 0, iv: null, run: false }
        };

        // 2. Firebase & Auth (è«‹å¡«å…¥é‡‘é‘°)
        const firebaseConfig = { apiKey: "AIzaSyBNmnC1QQVwBMgTgjUVLw4xXZxIrVlAV6c",
                                authDomain: "gsat1-29951.firebaseapp.com",
                                projectId: "gsat1-29951",
                                storageBucket: "gsat1-29951.firebasestorage.app",
                                messagingSenderId: "165497162624",
                                appId: "1:165497162624:web:9ed2b73dc6db035cadcf65",
                                measurementId: "G-89J4P5W7MP" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function signOut() { auth.signOut(); }
        auth.onAuthStateChanged(user => {
            const lg = document.getElementById('loginGroup');
            const ui = document.getElementById('userInfo');
            if (user) {
                lg.classList.add('hidden'); ui.classList.remove('hidden');
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
            } else {
                lg.classList.remove('hidden'); ui.classList.add('hidden');
                Object.keys(timers).forEach(k => stopTimer(k));
            }
        });

        // 3. é›·é”åœ–åˆå§‹åŒ– (8è»¸)
        const ctx = document.getElementById('radarChart').getContext('2d');
        const radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['æ•¸', 'è‹±', 'åœ‹', 'ç‰©', 'åŒ–', 'ç”Ÿ', 'åœ°', 'ç¤¾'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                    borderColor: '#1e3a8a', backgroundColor: 'rgba(30,58,138,0.1)', pointRadius: 2
                }]
            },
            options: { scales: { r: { min: 0, suggestedMax: 10, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });

        // 4. 8ç§‘è¨ˆæ™‚é‚è¼¯
        function toggleTimer(id) {
            const t = timers[id];
            if (t.run) { stopTimer(id); } 
            else {
                // æš«åœå…¶ä»–æ‰€æœ‰ç§‘ç›®
                Object.keys(timers).forEach(k => { if(timers[k].run) stopTimer(k); });
                startTimer(id);
            }
        }

        function startTimer(id) {
            const t = timers[id];
            const btn = document.getElementById(`btn-${id}`);
            const card = document.getElementById(`card-${id}`);
            t.run = true;
            btn.innerText = "æš«åœ"; btn.classList.replace('bg-blue-600', 'bg-red-500');
            card.classList.add('active');
            t.iv = setInterval(() => {
                t.s++;
                const fmt = s => new Date(s * 1000).toISOString().substr(11, 8);
                document.getElementById(`timer-${id}`).innerText = fmt(t.s);
                // æ›´æ–°é›·é”åœ– (ä»¥åˆ†é˜ç‚ºå–®ä½)
                const idx = Object.keys(timers).indexOf(id);
                radarChart.data.datasets[0].data[idx] = t.s / 60;
                radarChart.update('none');
            }, 1000);
        }

        function stopTimer(id) {
            const t = timers[id];
            const btn = document.getElementById(`btn-${id}`);
            const card = document.getElementById(`card-${id}`);
            t.run = false;
            btn.innerText = "é–‹å§‹"; btn.classList.replace('bg-red-500', 'bg-blue-600');
            card.classList.remove('active');
            clearInterval(t.iv);
        }

        // 5. AI è¨ºæ–·å¼•æ“
        function handleImage(i) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('imgPreview').src = e.target.result; document.getElementById('previewContainer').classList.remove('hidden'); base64Image = e.target.result.split(',')[1]; };
            r.readAsDataURL(i.files[0]);
        }

        document.getElementById('aiBtn').addEventListener('click', async function() {
            const txt = document.getElementById('aiInput').value;
            if(!txt && !base64Image) return;
            this.innerText = "ğŸ” åˆ†æä¸­...";
            document.getElementById('aiResponse').classList.remove('hidden');
            try {
                const k = "AIzaSyDsRyI7A6mXQMlW6_98H0UKF-k6phVVQ8k";
                const parts = [{ text: "ä½ æ˜¯å­¸ç¿’å°èˆªå“¡ã€‚åˆ†æï¼š1.è©³è§£($å…¬å¼) 2.å–®å…ƒ 3.âš ï¸ç›²å€è¨ºæ–·(ç¼ºä¹èˆ‡èª¤è§£è§€å¿µ) 4.å»ºè­°ã€‚" }];
                if (txt) parts.push({ text: txt });
                if (base64Image) parts.push({ inline_data: { mime_type: "image/jpeg", data: base64Image } });
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${k}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts }] })
                });
                const d = await res.json();
                document.getElementById('aiText').innerText = d.candidates[0].content.parts[0].text;
                if (window.MathJax) MathJax.typesetPromise();
            } catch (e) { document.getElementById('aiText').innerText = "é€£ç·šå¤±æ•—"; }
            finally { this.innerText = "é–‹å§‹è¨ºæ–·"; }
        });

        // æ‹ç…§ (ç°¡åŒ–ç‰ˆ)
        async function openShareModal() { document.getElementById('shareModal').classList.remove('hidden'); const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); document.getElementById('webcam').srcObject = stream; }
        function closeShareModal() { document.getElementById('shareModal').classList.add('hidden'); const s = document.getElementById('webcam').srcObject; if(s) s.getTracks().forEach(t => t.stop()); }
        function takeSnap() { alert("åœ–ç‰‡å·²åˆæˆä¸¦å„²å­˜ï¼"); }
    </script>
</body>
</html>
